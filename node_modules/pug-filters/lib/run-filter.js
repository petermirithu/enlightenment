'use strict';

var jstransformer = require('jstransformer');
<<<<<<< HEAD
var uglify = require('uglify-js');
var CleanCSS = require('clean-css');
var resolve = require('resolve');

module.exports = filter;
=======
var resolve = require('resolve');

module.exports = filter;

function getMinifyTransformerName(outputFormat) {
  switch (outputFormat) {
    case 'js':
      return 'uglify-js';
    case 'css':
      return 'clean-css';
  }
}

>>>>>>> e100a71af6da32effbcb14a1bf1ca112a193289c
function filter(name, str, options, currentDirectory, funcName) {
  funcName = funcName || 'render';
  var trPath;
  try {
    try {
<<<<<<< HEAD
      trPath = resolve.sync('jstransformer-' + name, {basedir: currentDirectory || process.cwd()});
=======
      trPath = resolve.sync('jstransformer-' + name, {
        basedir: currentDirectory || process.cwd(),
      });
>>>>>>> e100a71af6da32effbcb14a1bf1ca112a193289c
    } catch (ex) {
      trPath = require.resolve('jstransformer-' + name);
    }
  } catch (ex) {
    var err = new Error('unknown filter ":' + name + '"');
    err.code = 'UNKNOWN_FILTER';
    throw err;
  }
  var tr = jstransformer(require(trPath));
  // TODO: we may want to add a way for people to separately specify "locals"
  var result = tr[funcName](str, options, options).body;
  if (options && options.minify) {
<<<<<<< HEAD
    try {
      switch (tr.outputFormat) {
        case 'js':
          result = uglify.minify(result, {fromString: true}).code;
          break;
        case 'css':
          result = new CleanCSS().minify(result).styles;
          break;
      }
    } catch (ex) {
      // better to fail to minify than output nothing
=======
    var minifyTranformer = getMinifyTransformerName(tr.outputFormat);
    if (minifyTranformer) {
      try {
        result = filter(minifyTranformer, result, null, currentDirectory);
      } catch (ex) {
        // better to fail to minify than output nothing
      }
>>>>>>> e100a71af6da32effbcb14a1bf1ca112a193289c
    }
  }
  return result;
}
